<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Zondbi Roguelite — Предфинал</title>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg0:#0b0f1a; --bg1:#111827; --fg:#e6edf3; --muted:#9fb0c2;
    --accent:#5eead4; --accent2:#f472b6; --danger:#ef4444; --ok:#22c55e;
    --panel:#0f172a80; --card:#0b102080; --shadow:0 8px 30px rgba(0,0,0,.35);
  }
  html,body{margin:0;height:100%;color:var(--fg);background:#0b0f1a;overflow:hidden;font-family:"Rubik",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  #game{position:fixed;inset:0;display:block;background:
    radial-gradient(1000px 700px at 50% 50%, rgba(60,80,120,.12), transparent 70%),
    radial-gradient(1800px 1200px at 20% 80%, rgba(90,140,220,.08), transparent 70%),
    linear-gradient(180deg, #0b0f1a, #0b0f1a);}
  .ui{position:fixed;inset:0;pointer-events:none;}
  .hud{position:absolute;left:16px;top:16px;right:16px;display:flex;gap:12px;align-items:center}
  .panel{background:var(--panel);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08);
    border-radius:12px;padding:10px 12px;box-shadow:var(--shadow)}
  .hpbar,.xpbar,.stambar{position:relative;width:280px;height:16px;background:linear-gradient(180deg,#0d1223,#0a0e1b);
    border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.07)}
  .hpbar .fill{position:absolute;inset:0;background:linear-gradient(90deg,#ef4444,#f59e0b)}
  .xpbar .fill{position:absolute;inset:0;background:linear-gradient(90deg,#60a5fa,#a78bfa)}
  .stambar .fill{position:absolute;inset:0;background:linear-gradient(90deg,#22c55e,#14b8a6)}
  .ammo{display:flex;align-items:center;gap:10px;min-width:200px}
  .ammo .value{font-weight:700;font-size:18px;letter-spacing:.5px}
  .ammo .label{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.1em}
  .right{margin-left:auto;display:flex;align-items:center;gap:12px}
  .chip{font-size:12px;padding:6px 10px;border-radius:999px;background:#0d1323bb;border:1px solid rgba(255,255,255,.08)}
  .chip.warn{background:#23140fbb;color:#ffd2b0;border-color:#ffb48a44}
  .chip.ok{background:#0f231bbb;color:#b6ffe0;border-color:#6afad744}
  .chip.bad{background:#231015bb;color:#ffc7cf;border-color:#ff9ab144}
  .bigcenter{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:auto}
  .dialog{background:linear-gradient(180deg,#0d1323cc,#0a0f1acc);border:1px solid rgba(255,255,255,.1);
    border-radius:16px;padding:20px;box-shadow:var(--shadow);max-width:980px;width:min(92vw,980px)}
  .dialog h1,.dialog h2,.dialog h3{margin:0 0 10px}
  .dialog .sub{color:var(--muted)}
  .roles{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin:12px 0}
  .role{background:var(--card);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:14px;cursor:pointer;transition:.15s transform}
  .role:hover{transform:translateY(-2px)}
  .role h3{margin:0 0 6px}
  .role ul{margin:6px 0 0 18px;padding:0}
  .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
  .btn{pointer-events:auto;cursor:pointer;background:linear-gradient(180deg,#12203a,#0f1a2f);color:var(--fg);
    border:1px solid rgba(255,255,255,.12);padding:10px 14px;border-radius:12px;transition:.15s transform,.15s box-shadow;box-shadow:var(--shadow);user-select:none}
  .btn:hover{transform:translateY(-1px)}
  .btn.primary{background:linear-gradient(180deg,#1d355c,#142747);border-color:#6aa0ff44}
  .btn.danger{background:linear-gradient(180deg,#3a1320,#2a0f18);border-color:#ff6a8a44}
  .upgrades{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:8px}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:14px;cursor:pointer;transition:.15s transform}
  .card:hover{transform:translateY(-2px)}
  .card h3{margin:0 0 6px}
  .card p{margin:0;color:var(--muted)}
  .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;color:var(--muted)}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0f172acc;border:1px solid rgba(255,255,255,.12);
    border-radius:12px;padding:10px 14px;pointer-events:none;opacity:0;transition:.2s}
  .toast.show{opacity:1}
  .crosshair{position:fixed;width:18px;height:18px;pointer-events:none;border-radius:50%;
    border:2px solid rgba(255,255,255,.45);box-shadow:0 0 0 2px rgba(255,255,255,.06) inset;mix-blend-mode:screen;transform:translate(-50%,-50%)}
  .hordeBanner{position:fixed;top:0;left:0;right:0;height:6px;background:linear-gradient(90deg,#ef4444,#f59e0b,#ef4444);filter:drop-shadow(0 0 8px #ef444466);opacity:0;transition:.3s}
  .hordeBanner.show{opacity:1}
  .pickup{filter:drop-shadow(0 0 10px rgba(34,197,94,.3))}
</style>
</head>
<body>
<canvas id="game"></canvas>

<div class="ui">
  <div class="hordeBanner" id="hordeBanner"></div>
  <div class="hud">
    <div class="panel">
      <div style="display:flex;gap:10px;align-items:center">
        <div style="display:flex;flex-direction:column;gap:6px">
          <div class="hpbar" title="Здоровье"><div class="fill" id="hpFill" style="width:100%"></div></div>
          <div class="xpbar" title="Опыт"><div class="fill" id="xpFill" style="width:0%"></div></div>
        </div>
        <div class="stambar" style="width:160px" title="Выносливость"><div class="fill" id="stamFill" style="width:100%"></div></div>
        <div class="ammo" id="ammoBox">
          <div style="display:flex;flex-direction:column;line-height:1">
            <div class="label">Патроны</div>
            <div class="value"><span id="ammoInMag">0</span>/<span id="magSize">0</span> | <span id="ammoReserve">0</span></div>
          </div>
        </div>
        <div class="chip" id="weaponChip">Пистолет</div>
        <div class="chip bad" id="jamChip" style="display:none">КЛИН! [R]</div>
        <div class="chip warn" id="reloadChip" style="display:none">Перезарядка…</div>
        <div class="chip ok" id="parryChip" style="display:none">Идеальное парирование!</div>
        <div class="right">
          <div class="chip" id="hordeInfo">Орда через: 00:45</div>
          <div class="chip"><span id="timeTxt">00:00</span></div>
          <div class="chip"><span id="killsTxt">Фрагов: 0</span></div>
          <div class="chip"><span id="lvlTxt">Ур. 1</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="bigcenter" id="startScreen">
    <div class="dialog">
      <h1>ЗОНДБИ: НОЧЬ ОРДЫ — Предфинал</h1>
      <div class="sub">Выберите класс и переживите орды. Новые боссы, оружие, телеграфы и медкиты!</div>
      <div class="roles">
        <div class="role" id="pickRanged">
          <h3>Стрелок</h3>
          <div class="sub">Огнестрел, перезарядка, клин.</div>
          <ul>
            <li>ЛКМ — стрелять</li>
            <li>R — перезарядка/устранить клин</li>
            <li>ПКМ — блок/парирование</li>
          </ul>
        </div>
        <div class="role" id="pickMelee">
          <h3>Клинок</h3>
          <div class="sub">Чистый ближний бой + рывок.</div>
          <ul>
            <li>ЛКМ — рубящий удар</li>
            <li>Shift — рывок</li>
            <li>ПКМ — блок/парирование (контратака)</li>
          </ul>
        </div>
      </div>
      <div class="actions">
        <div class="btn primary" id="startBtn">Играть [Пробел/Enter]</div>
        <div class="btn" id="muteBtn">Звук: Вкл</div>
      </div>
      <div class="legend">
        <span class="badge">Периодически — ОРДА</span>
        <span class="badge">Телеграфы: успей парировать!</span>
        <span class="badge">Медкиты появляются со временем</span>
      </div>
    </div>
  </div>

  <div class="bigcenter" id="upgradeScreen" style="display:none;">
    <div class="dialog">
      <h2>Улучшение — выберите одно</h2>
      <div class="upgrades" id="upgradeCards"></div>
      <div class="legend"><span>Подсказка: можно нажать 1 / 2 / 3.</span></div>
    </div>
  </div>

  <div class="bigcenter" id="deathScreen" style="display:none;">
    <div class="dialog">
      <h2>Вы пали от лап зондби…</h2>
      <div class="sub" id="deathStats">Время: 00:00 · Фрагов: 0 · Уровень: 1</div>
      <div class="actions">
        <div class="btn primary" id="restartBtn">Заново [R]</div>
        <div class="btn danger" id="quitBtn">Выйти</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Сообщение</div>
</div>

<div class="crosshair" id="crosshair"></div>

<script>
(() => {
  // Utils
  const TAU=Math.PI*2, clamp=(v,a,b)=>Math.max(a,Math.min(b,v)), lerp=(a,b,t)=>a+(b-a)*t;
  const rnd=(a=1,b=null)=> b===null ? Math.random()*a : a + Math.random()*(b-a);
  const rndi=(a,b)=> Math.floor(rnd(a,b+1)); const now=()=>performance.now(); const fmt2=n=>String(n).padStart(2,'0');

  // Canvas
  const canvas=document.getElementById('game'), ctx=canvas.getContext('2d');
  let DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1));
  function resize(){ DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1)); const w=Math.floor(innerWidth*DPR),h=Math.floor(innerHeight*DPR); canvas.width=w; canvas.height=h; canvas.style.width=innerWidth+'px'; canvas.style.height=innerHeight+'px'; }
  addEventListener('resize',resize); resize();

  // DOM
  const hpFill=document.getElementById('hpFill'), xpFill=document.getElementById('xpFill'), stamFill=document.getElementById('stamFill');
  const ammoInMag=document.getElementById('ammoInMag'), ammoReserve=document.getElementById('ammoReserve'), magSizeEl=document.getElementById('magSize'), ammoBox=document.getElementById('ammoBox');
  const weaponChip=document.getElementById('weaponChip'), jamChip=document.getElementById('jamChip'), reloadChip=document.getElementById('reloadChip'), parryChip=document.getElementById('parryChip');
  const hordeInfo=document.getElementById('hordeInfo'), timeTxt=document.getElementById('timeTxt'), killsTxt=document.getElementById('killsTxt'), lvlTxt=document.getElementById('lvlTxt');
  const startScreen=document.getElementById('startScreen'), startBtn=document.getElementById('startBtn'), muteBtn=document.getElementById('muteBtn');
  const pickRanged=document.getElementById('pickRanged'), pickMelee=document.getElementById('pickMelee');
  const upgradeScreen=document.getElementById('upgradeScreen'), upgradeCards=document.getElementById('upgradeCards');
  const deathScreen=document.getElementById('deathScreen'), deathStats=document.getElementById('deathStats'), restartBtn=document.getElementById('restartBtn'), quitBtn=document.getElementById('quitBtn');
  const toastEl=document.getElementById('toast'), crosshairEl=document.getElementById('crosshair'), hordeBanner=document.getElementById('hordeBanner');

  // Input
  const keys={}; const mouse={x:0,y:0,worldX:0,worldY:0,downL:false,downR:false};
  addEventListener('keydown',e=>{
    keys[e.key.toLowerCase()]=true;
    if ((e.key===' '||e.key==='Enter') && mode==='start') startGame();
    if (e.key.toLowerCase()==='r' && mode==='dead') startGame();
    if (mode==='upgrade' && ['1','2','3'].includes(e.key)) pickUpgrade(parseInt(e.key)-1);
    if (mode==='game'){
      if (e.key.toLowerCase()==='p') togglePause();
      if (player && player.charType==='ranged' && e.key.toLowerCase()==='r') playerRequestReloadOrUnjam();
    }
  });
  addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);
  addEventListener('mousemove',e=>{ mouse.x=e.clientX; mouse.y=e.clientY; crosshairEl.style.left=mouse.x+'px'; crosshairEl.style.top=mouse.y+'px'; });
  addEventListener('mousedown',e=>{
    if (mode==='upgrade') return;
    // НЕ автозапускаем игру кликом по стартовому экрану
    if (mode==='start') return;
    if (e.button===0) mouse.downL=true; if (e.button===2) mouse.downR=true;
  },{passive:true});
  addEventListener('contextmenu',e=>e.preventDefault());
  addEventListener('mouseup',e=>{ if (e.button===0) mouse.downL=false; if (e.button===2) mouse.downR=false; });

  startBtn.onclick=()=>startGame();
  muteBtn.onclick=()=>{ audio.muted=!audio.muted; muteBtn.textContent='Звук: '+(audio.muted?'Выкл':'Вкл'); };
  pickRanged.onclick=e=>{ e.stopPropagation(); chosenClass='ranged'; toast('Класс: Стрелок'); };
  pickMelee.onclick=e=>{ e.stopPropagation(); chosenClass='melee'; toast('Класс: Клинок'); };
  restartBtn.onclick=()=>startGame();
  quitBtn.onclick=()=>location.reload();

  // Audio
  const audio={
    ctx:null, muted:false,
    ensure(){ if(!this.ctx) this.ctx=new (window.AudioContext||window.webkitAudioContext)(); },
    beep({f=440,t=.08,v=.2,type='square',slide=0,attack=.001}={}){ if(this.muted) return; this.ensure(); const c=this.ctx,t0=c.currentTime,o=c.createOscillator(),g=c.createGain(); o.type=type; o.frequency.setValueAtTime(f,t0); if(slide) o.frequency.linearRampToValueAtTime(f+slide,t0+t); g.gain.setValueAtTime(0.0001,t0); g.gain.exponentialRampToValueAtTime(v,t0+attack); g.gain.exponentialRampToValueAtTime(0.0001,t0+t); o.connect(g); g.connect(c.destination); o.start(t0); o.stop(t0+t+.02); },
    shoot(){ this.beep({f:600,t:.05,v:.12,type:'square',slide:-200}); },
    shotgun(){ this.beep({f:180,t:.12,v:.2,type:'sawtooth',slide:-120}); },
    cannon(){ this.beep({f:220,t:.12,v:.22,type:'triangle',slide:-60}); },
    reload(){ this.beep({f:300,t:.08,v:.12,type:'triangle'}); },
    click(){ this.beep({f:200,t:.02,v:.08,type:'square'}); },
    hit(){ this.beep({f:120,t:.04,v:.15,type:'sine'}); },
    kill(){ this.beep({f:220,t:.12,v:.18,type:'square',slide:-120}); },
    level(){ this.beep({f:500,t:.2,v:.22,type:'triangle',slide:180}); },
    parry(){ this.beep({f:900,t:.12,v:.2,type:'triangle'}); },
    block(){ this.beep({f:260,t:.06,v:.12,type:'sine'}); },
    jam(){ this.beep({f:120,t:.14,v:.22,type:'sawtooth'}); },
    horde(){ this.beep({f:140,t:.3,v:.25,type:'square',slide:-100}); },
    dash(){ this.beep({f:420,t:.06,v:.18,type:'triangle'}); },
    boss(){ this.beep({f:90,t:.5,v:.28,type:'sawtooth'}); },
    mortar(){ this.beep({f:160,t:.2,v:.2,type:'sawtooth'}); },
  };

  // State
  let mode='start', chosenClass='ranged', t=0, lastTime=now();
  let camera={x:0,y:0};
  let player=null; let bullets=[], eBullets=[], zombies=[], particles=[], orbs=[], pickups=[];
  let kills=0, startTimeMs=0, elapsedMs=0;
  let horde={active:false,nextAt:45000,until:0,period:45000,duration:14000};
  let boss={nextAt:75000, alive:false};
  let medkits={nextAt:20000, period:[18000,26000]};
  let paused=false;

  // Weapons
  const weaponsCatalog={
    Pistol:   {name:'Пистолет', type:'pistol', damage:16, bulletSpeed:680, fireRate:4.5, spread:6,  magSize:12, ammoReserve:84,  reloadTime:900,  multiShots:1, jamChance:0.03, pierce:0},
    SMG:      {name:'ПП',       type:'smg',    damage:10, bulletSpeed:750, fireRate:10.5,spread:9,  magSize:28, ammoReserve:180, reloadTime:1100, multiShots:1, jamChance:0.035,pierce:0},
    Shotgun:  {name:'Дробовик', type:'shotgun',damage:8,  bulletSpeed:640, fireRate:1.8, spread:16, magSize:5,  ammoReserve:35,  reloadTime:1300, multiShots:7, jamChance:0.04, pierce:0},
    Rifle:    {name:'Карабин',  type:'rifle',  damage:26, bulletSpeed:900, fireRate:2.8, spread:3,  magSize:8,  ammoReserve:56,  reloadTime:1200, multiShots:1, jamChance:0.025,pierce:1},
    Cannon:   {name:'Ручная пушка', type:'cannon', damage:44, bulletSpeed:700, fireRate:1.8, spread:5, magSize:5, ammoReserve:30, reloadTime:1300, multiShots:1, jamChance:0.03, pierce:1},
    TriBeam:  {name:'Три-луч', type:'tribeam', damage:12, bulletSpeed:720, fireRate:4.0, spread:6, magSize:10, ammoReserve:70, reloadTime:1100, multiShots:3, jamChance:0.03, pierce:0},
  };
  const weaponVisual = {
    pistol:{len:20,h:8,color:'#8ab4ff',muzzle:'#a7f3d0'},
    smg:{len:22,h:7,color:'#5eead4',muzzle:'#99f6e4'},
    shotgun:{len:26,h:9,color:'#f59e0b',muzzle:'#fbbf24'},
    rifle:{len:26,h:7,color:'#9cdcfe',muzzle:'#9cdcfe'},
    cannon:{len:24,h:10,color:'#f472b6',muzzle:'#fda4af'},
    tribeam:{len:22,h:7,color:'#7dd3fc',muzzle:'#bae6fd'},
    blade:{len:22,h:6,color:'#fda4af',muzzle:'#fecdd3'}
  };
  function copyWeapon(proto){ const w=JSON.parse(JSON.stringify(proto)); w.ammoInMag=w.magSize; return w; }

  // Модификаторы оружия (переносятся между стволами)
  function baseRangedMods(){ return {magMul:1, reloadMul:1, fireRateMul:1, damageMul:1, spreadMul:1, multiAdd:0, pierceAdd:0, jamMul:1}; }
  function applyWeaponMods(g){
    const b = g._baseWeapon; const m=g.rangedMods;
    const w = copyWeapon(b);
    w.magSize = Math.max(1, Math.round(w.magSize * m.magMul));
    w.ammoInMag = Math.min(w.magSize, w.ammoInMag||w.magSize);
    w.ammoReserve = Math.round(b.ammoReserve); // запас не масштабируем для предсказуемости
    w.reloadTime = Math.round(w.reloadTime * m.reloadMul);
    w.fireRate *= m.fireRateMul;
    w.damage *= m.damageMul;
    w.spread *= m.spreadMul;
    w.multiShots = Math.max(1, (w.multiShots||1) + m.multiAdd);
    w.pierce = (w.pierce||0) + m.pierceAdd;
    w.jamChance *= m.jamMul;
    g.weapon = w;
    weaponChip.textContent = w.name;
    magSizeEl.textContent = w.magSize; ammoInMag.textContent = w.ammoInMag; ammoReserve.textContent=w.ammoReserve;
  }
  function setWeapon(g, proto){ g._baseWeapon = proto; applyWeaponMods(g); toast(`Оружие: ${proto.name}`); }

  // Player
  function makePlayer(charType='ranged'){
    const p={
      x:0,y:0,angle:0,charType,
      speed: charType==='melee'? 270 : 240, radius:16,
      hp:100,maxHp:100, stamina:100,maxStamina:100,
      block:false,blockStaminaDrain:28,blockDamageReduct:0.6, parryWindow:170,lastBlockStart:-999,parryActive:false,
      jammed:false,jamUntil:0,reloading:false,reloadUntil:0,
      knifeCooldown:0,fireCooldown:0,lifesteal:0,
      xp:0,level:1,xpToNext:60,
      // melee
      mDamage:28, mRange:70, mArc:Math.PI/2.4, mRate:3.0, bleed:false, bleedDps:10,
      dashCD:0, dashCDmax:1.5, dashTime:0, dashSpeed:800, invulUntil:0,
      // ranged mods
      rangedMods: baseRangedMods(),
      explosiveRounds:false
    };
    if (charType==='ranged'){ p._baseWeapon = weaponsCatalog.Pistol; applyWeaponMods(p); }
    return p;
  }

  // Upgrades
  const U={
    common:[
      {id:'hp+',name:'Живчик',desc:'+25 к макс. здоровью',apply:g=>{g.maxHp+=25; g.hp+=25;}},
      {id:'stam+',name:'Выносливость',desc:'+20 к макс. выносливости',apply:g=>{g.maxStamina+=20; g.stamina+=20;}},
      {id:'regen+',name:'Лёгкое дыхание',desc:'+30% восстановление стамины',apply:g=>{g.staminaRegen=(g.staminaRegen||22)*1.3;}},
      {id:'guard+',name:'Надёжный блок',desc:'-25% урон сквозь блок',apply:g=>{g.blockDamageReduct=1-(1-g.blockDamageReduct)*0.75;}},
      {id:'parry+',name:'Мастер парирования',desc:'+70 мс окно парирования',apply:g=>{g.parryWindow+=70;}},
      {id:'move+',name:'Лёгкие ботинки',desc:'+12% скорость',apply:g=>{g.speed*=1.12;}},
      {id:'leech',name:'Подранки',desc:'+4% вампиризм',apply:g=>{g.lifesteal=(g.lifesteal||0)+0.04;}},
    ],
    ranged:[
      {id:'mag+',name:'Больший магазин',desc:'+35% магазин',apply:g=>{g.rangedMods.magMul*=1.35; applyWeaponMods(g);}},
      {id:'reload+',name:'Быстрая перезарядка',desc:'-25% время перезарядки',apply:g=>{g.rangedMods.reloadMul*=0.75; applyWeaponMods(g);}},
      {id:'fire+',name:'Скорострельность',desc:'+22% темп',apply:g=>{g.rangedMods.fireRateMul*=1.22; applyWeaponMods(g);}},
      {id:'dmg+',name:'Калибр покрупнее',desc:'+25% урон',apply:g=>{g.rangedMods.damageMul*=1.25; applyWeaponMods(g);}},
      {id:'spread+',name:'Стабильность',desc:'-20% разброс и шанс клина',apply:g=>{g.rangedMods.spreadMul*=0.8; g.rangedMods.jamMul*=0.75; applyWeaponMods(g);}},
      {id:'multi+',name:'Мультивыстрел',desc:'+1 снаряд',apply:g=>{g.rangedMods.multiAdd+=1; applyWeaponMods(g);}},
      {id:'pierce',name:'Пробитие',desc:'+1 пробитие',apply:g=>{g.rangedMods.pierceAdd+=1; applyWeaponMods(g);}},
      {id:'expl',name:'Взрывные пули',desc:'При смерти врага — AOE',apply:g=>{g.explosiveRounds=true;}},
      {id:'w_smg',name:'ПП',desc:'Очень скорострельное',apply:g=>setWeapon(g,weaponsCatalog.SMG)},
      {id:'w_shotgun',name:'Дробовик',desc:'Залп дроби',apply:g=>setWeapon(g,weaponsCatalog.Shotgun)},
      {id:'w_rifle',name:'Карабин',desc:'Точный урон',apply:g=>setWeapon(g,weaponsCatalog.Rifle)},
      {id:'w_cannon',name:'Ручная пушка',desc:'Мощный калибр',apply:g=>setWeapon(g,weaponsCatalog.Cannon)},
      {id:'w_tribeam',name:'Три-луч',desc:'Три луча за выстрел',apply:g=>setWeapon(g,weaponsCatalog.TriBeam)},
    ],
    melee:[
      {id:'m_dmg',name:'Острые края',desc:'+25% урон ближним',apply:g=>{g.mDamage*=1.25;}},
      {id:'m_arc',name:'Широкий взмах',desc:'+20% дуга удара',apply:g=>{g.mArc*=1.2;}},
      {id:'m_range',name:'Длинное лезвие',desc:'+20 радиус удара',apply:g=>{g.mRange+=20;}},
      {id:'m_rate',name:'Быстрый клинок',desc:'+25% скорость атаки',apply:g=>{g.mRate*=1.25;}},
      {id:'m_bleed',name:'Кровотечение',desc:'Удары накладывают DOT',apply:g=>{g.bleed=true;}},
      {id:'dash+',name:'Лёгкий рывок',desc:'КД рывка -30%',apply:g=>{g.dashCDmax*=0.7;}},
      {id:'dashDmg',name:'Прорыв',desc:'Рывок наносит урон',apply:g=>{g.dashDamage=true;}},
      {id:'counter',name:'Контратака',desc:'Парирование бьёт сильнее',apply:g=>{g.parryCounter=true;}},
      {id:'whirl',name:'Вихрь',desc:'Серия ударов при удержании',apply:g=>{g.whirl=true;}},
    ],
  };
  function poolFor(g){ return g.charType==='ranged' ? [...U.common,...U.ranged] : [...U.common,...U.melee]; }
  function randomUpgrades(g,n=3){ const pool=poolFor(g); const picks=[]; for(let i=0;i<n&&pool.length;i++) picks.push(pool.splice(rndi(0,pool.length-1),1)[0]); return picks; }
  function showUpgrade(){ mode='upgrade'; upgradeScreen.style.display='flex'; const picks=randomUpgrades(player,3); upgradeCards.innerHTML=''; picks.forEach((u,i)=>{ const d=document.createElement('div'); d.className='card'; d.innerHTML=`<h3>${u.name}</h3><p>${u.desc}</p><div class="badge" style="margin-top:8px;">[${i+1}]</div>`; d.onclick=()=>applyUpgrade(u); upgradeCards.appendChild(d); }); upgradeScreen._picks=picks; audio.level(); }
  function applyUpgrade(u){ u.apply(player); hideUpgrade(); updateHud(); toast(`Улучшение: ${u.name}`); }
  function hideUpgrade(){ mode='game'; upgradeScreen.style.display='none'; }
  function pickUpgrade(idx){ const picks=upgradeScreen._picks||[]; if(picks[idx]) applyUpgrade(picks[idx]); }

  // HUD
  function updateHud(){
    if(!player) return;
    hpFill.style.width=`${(player.hp/player.maxHp)*100}%`;
    xpFill.style.width=`${(player.xp/player.xpToNext)*100}%`;
    stamFill.style.width=`${(player.stamina/player.maxStamina)*100}%`;
    lvlTxt.textContent=`Ур. ${player.level}`;
    if(player.charType==='ranged'){
      ammoBox.style.display='flex';
      const w=player.weapon; ammoInMag.textContent=w.ammoInMag; ammoReserve.textContent=w.ammoReserve; magSizeEl.textContent=w.magSize; weaponChip.textContent=w.name;
      jamChip.style.display=player.jammed?'inline-flex':'none'; reloadChip.style.display=player.reloading?'inline-flex':'none';
    } else {
      ammoBox.style.display='none'; weaponChip.textContent='Клинок'; jamChip.style.display='none'; reloadChip.style.display='none';
    }
  }
  function toast(msg,time=1200){ toastEl.textContent=msg; toastEl.classList.add('show'); clearTimeout(toastEl._t); toastEl._t=setTimeout(()=>toastEl.classList.remove('show'), time); }

  // Control
  function startGame(){
    mode='game'; paused=false;
    startScreen.style.display='none'; upgradeScreen.style.display='none'; deathScreen.style.display='none';
    bullets.length=0; eBullets.length=0; zombies.length=0; particles.length=0; orbs.length=0; pickups.length=0;
    kills=0; player=makePlayer(chosenClass); if(player.charType==='ranged') applyWeaponMods(player);
    camera.x=player.x; camera.y=player.y; horde.active=false; horde.nextAt=45000; horde.until=0;
    boss.alive=false; boss.nextAt=75000;
    medkits.nextAt=20000;
    startTimeMs=now(); lastTime=now(); audio.level(); updateHud();
  }
  function togglePause(){ if(mode!=='game'&&mode!=='pause') return; paused=!paused; mode=paused?'pause':'game'; toast(paused?'Пауза':'Продолжим!'); }
  function endGame(){ mode='dead'; deathScreen.style.display='flex'; const s=((elapsedMs/1000)|0); deathStats.textContent=`Время: ${fmt2((s/60)|0)}:${fmt2(s%60)} · Фрагов: ${kills} · Уровень: ${player.level}`; }

  // Enemies
  function baseZombie(){
    const dist=rnd(420,900), ang=rnd(0,TAU);
    return {
      x:player.x+Math.cos(ang)*dist, y:player.y+Math.sin(ang)*dist,
      radius:rnd(14,20), speed:rnd(60,95)*(horde.active?1.15:1),
      hp:rnd(26,40)*(horde.active?1.2:1), maxHp:40, damage:rnd(8,13),
      state:'chase', nextAttack:0, windup:260, cooldown:900, attackRange:60, stunnedUntil:0,
      color:`hsl(${rndi(120,160)},30%,60%)`, type:'normal',
      teleStart:0, teleDur:0, bleedTickUntil:0, bleedDps:0,
      dashUntil:0, dashCooldown:0
    };
  }
  function makeZombie(){ const z=baseZombie(); return z; }
  function makeFast(){ const z=baseZombie(); z.type='fast'; z.speed*=1.8; z.radius=12; z.hp*=0.7; z.attackRange=56; z.color='#7cffc6'; return z; }
  function makeRanged(){ const z=baseZombie(); z.type='ranged'; z.speed*=0.9; z.hp*=1.1; z.windup=420; z.cooldown=rnd(1100,1500); z.attackRange=340; z.color='#a3e635'; return z; }
  function makeDodger(){ const z=baseZombie(); z.type='dodger'; z.speed*=1.1; z.radius=15; z.cooldown=rnd(900,1200); z.color='#93c5fd'; return z; }
  function makeBoss(){
    const z=baseZombie(); z.type='boss'; z.radius=36; z.hp=900*(1+elapsedMs/120000); z.maxHp=z.hp; z.speed=85; z.damage=20; z.color='#f97316';
    z.windup=700; z.cooldown=1200; z.attackRange=90; z.boss=true; boss.alive=true; audio.boss(); toast('БОСС ПРИБЫЛ!',1600); return z;
  }
  function makeBossMortar(){
    const z=baseZombie(); z.type='boss2'; z.radius=34; z.hp=820*(1+elapsedMs/120000); z.maxHp=z.hp; z.speed=70; z.damage=16; z.color='#eab308';
    z.windup=800; z.cooldown=1500; z.attackRange=420; z.boss=true; z.mortarCd=0; boss.alive=true; audio.boss(); toast('Страж-мортирщик!',1600); return z;
  }

  // Глобальный обработчик ближней атаки врага (учитывает блок/парирование)
function takeMeleeHit(z, atTime = now()) {
  if (!player) return;
  const inRange = Math.hypot(player.x - z.x, player.y - z.y) < 48 + z.radius + player.radius;
  if (!inRange) return;

  let dmg = z.damage;

  if (player.block) {
    const blockStartAgo = atTime - player.lastBlockStart;
    if (blockStartAgo <= player.parryWindow) {
      // идеальное парирование
      parryFlash();
      audio.parry();
      z.stunnedUntil = atTime + (z.type === 'boss' ? 500 : 1500);
      dmg = 0;
      z.hp -= (player.parryCounter ? 40 : 20);
      if (z.hp <= 0) {
        const idx = zombies.indexOf(z);
        if (idx >= 0) killZombie(idx, z);
      }
    } else {
      // обычный блок — часть урона проходит
      dmg *= (1 - player.blockDamageReduct);
      audio.block();
    }
  }

  if (dmg > 0) takeDamage(dmg);
}

  // Telegraphed attacks
  function startWindup(z, dur){ z.state='windup'; z.teleStart=now(); z.teleDur=dur||z.windup; }
  function enemyTryAttack(z, nowMs){
    if (z.state!=='chase') return;
    const d=Math.hypot(player.x-z.x, player.y-z.y);
    if (d < z.attackRange && nowMs >= z.nextAttack){
      startWindup(z);
    }
  }
  function enemyPerformAttack(z, nowMs){
    // After windup finishes
    if (z.type==='ranged' || z.type==='boss2'){
      // shoot projectile(s)
      if (z.type==='ranged'){ enemyShoot(z); }
      else { mortarVolley(z); }
    } else {
      // melee strike
      takeMeleeHit(z, nowMs);
    }
    z.state='chase'; z.nextAttack = nowMs + z.cooldown;
  }

  function enemyShoot(z){
    const a=Math.atan2(player.y-z.y, player.x-z.x);
    const speed = (z.type==='boss2'? 260 : 420);
    const dmg   = (z.type==='boss2'? 18  : 12);
    const color = (z.type==='boss2'? '#fde047' : '#bbf7d0');
    eBullets.push({x:z.x+Math.cos(a)*z.radius, y:z.y+Math.sin(a)*z.radius, vx:Math.cos(a)*speed, vy:Math.sin(a)*speed, r: z.type==='boss2'? 8:5, damage:dmg, born:now(), life:2600, color, from:z});
  }
  function mortarVolley(z){
    audio.mortar();
    // 3 телеграфа на землю вокруг игрока
    for(let i=0;i<3;i++){
      const ang=rnd(0,TAU), dist=rnd(80,220);
      const tx=player.x+Math.cos(ang)*dist, ty=player.y+Math.sin(ang)*dist;
      pickups.push({type:'telegraph',x:tx,y:ty,r:18, born:now(), life:900, color:'rgba(239,68,68,.35)'}); // круг-предупреждение
      setTimeout(()=>{ // взрыв
        for(let n=0;n<12;n++){
          const a=(n/12)*TAU;
          eBullets.push({x:tx,y:ty, vx:Math.cos(a)*300, vy:Math.sin(a)*300, r:6, damage:14, born:now(), life:2000, color:'#fca5a5'});
        }
      }, 900);
    }
  }

  // XP Orbs
  function makeOrb(x,y,xp=10){ return {x,y,vx:rnd(-20,20),vy:rnd(-20,20),r:5,xp,life:7000,born:now()}; }

  // Particles
  function addParticle(x,y,color,life=450,size=3,spread=120,speed=80){
    const a=rnd(0,TAU); particles.push({x,y,vx:Math.cos(a)*rnd(20,speed),vy:Math.sin(a)*rnd(20,speed),r:size,life,born:now(),color});
  }

  // Pickups (medkits + telegraphs)
  function spawnMedkit(){
    const dist=rnd(260,520), ang=rnd(0,TAU);
    pickups.push({type:'medkit', x:player.x+Math.cos(ang)*dist, y:player.y+Math.sin(ang)*dist, r:12, born:now(), life:20000, heal:35});
  }

  // Ranged reload/jam
  function playerRequestReloadOrUnjam(){
    if(!player || player.charType!=='ranged') return;
    const w=player.weapon;
    if(player.jammed){ player.jamUntil=now()+Math.max(100,(player.jamUntil-now())*0.35); audio.click(); toast('Пытаетесь устранить клин…',600); return; }
    if(player.reloading) return;
    if(w.ammoInMag>=w.magSize) return;
    if(w.ammoReserve<=0 && w.ammoInMag>0) return;
    if(w.ammoReserve<=0 && w.ammoInMag===0) return;
    player.reloading=true; player.reloadUntil=now()+w.reloadTime; updateHud(); audio.reload();
  }

  // Unified zombie death
  function killZombie(idx, z){
    if (z.type==='boss' || z.type==='boss2') boss.alive=false;
    zombies.splice(idx,1); kills++;
    addParticle(z.x,z.y,'#9ae6b4',500,3,160,140);
    orbs.push(makeOrb(z.x,z.y, rndi(12,20)*(z.boss?6:1)));
    audio.kill();
    player.xp += rndi(8,16)*(z.boss?6:1);
    if (player.xp >= player.xpToNext){ player.level++; player.xp -= player.xpToNext; player.xpToNext = Math.round(player.xpToNext*1.2+20); updateHud(); showUpgrade(); } else updateHud();
    if (player.explosiveRounds){
      for(let k=0;k<16;k++) addParticle(z.x,z.y,'#fbbf24',500,3,200,200);
      zombies.forEach(zz=>{ const dd=Math.hypot(zz.x-z.x,zz.y-z.y); if(dd<100) zz.hp-=22; });
    }
  }

  // Shooting
  function tryShoot(tx,ty){
    if(!player || player.charType!=='ranged') return;
    const w=player.weapon; if(player.jammed||player.reloading) return; if(player.fireCooldown>0) return;
    if(w.ammoInMag<=0){ if(w.ammoReserve>0) { playerRequestReloadOrUnjam(); return; } else { knifeFallback(); return; } }
    if(Math.random()<w.jamChance){ player.jammed=true; player.jamUntil=now()+rnd(700,1400); jamChip.style.display='inline-flex'; audio.jam(); return; }

    const baseAngle=Math.atan2(ty-player.y, tx-player.x), spread=w.spread*Math.PI/180;
    const volleyCount = (w.type==='shotgun') ? 1 : (w.multiShots||1);
    for(let i=0;i<volleyCount;i++){
      let angle = baseAngle + (i - (volleyCount-1)/2) * (spread*0.6);
      let pellets = (w.type==='shotgun') ? w.multiShots : 1;
      for(let p=0;p<pellets;p++){
        const a = angle + (w.type==='shotgun'? rnd(-spread*0.8,spread*0.8) : rnd(-spread,spread));
        bullets.push({x:player.x+Math.cos(a)*22, y:player.y+Math.sin(a)*22, vx:Math.cos(a)*w.bulletSpeed, vy:Math.sin(a)*w.bulletSpeed, r:4, damage:w.damage, life:900, born:now(), pierce:w.pierce||0, color: weaponVisual[w.type]?.muzzle || '#a7f3d0'});
      }
    }
    w.ammoInMag = Math.max(0, w.ammoInMag-1);
    player.fireCooldown = 1000/w.fireRate;
    if (w.type==='shotgun') audio.shotgun(); else if (w.type==='cannon') audio.cannon(); else audio.shoot();
    addParticle(player.x,player.y,'#ffffff',80,2,0,0);
    updateHud();
  }
  function knifeFallback(){ if(player.knifeCooldown>0) return; player.knifeCooldown=320; audio.hit(); slashAttack(22,64,Math.PI/3,false); }

  // Melee
  function meleeAttack(){
    if(player.fireCooldown>0) return;
    const dmg=player.mDamage, range=player.mRange, arc=player.mArc;
    player.fireCooldown = 1000/player.mRate;
    audio.hit();
    slashAttack(dmg, range, arc, true);
  }
  function slashAttack(dmg, range, arc, applyBleed){
    // Обновлено: наносим урон и корректно убиваем врагов
    let hitAny=false;
    for (let j=zombies.length-1;j>=0;j--){
      const z=zombies[j];
      const dx=z.x-player.x, dy=z.y-player.y; const d=Math.hypot(dx,dy);
      if (d < range + z.radius){
        const za=Math.atan2(dy,dx); const da=Math.atan2(Math.sin(za-player.angle), Math.cos(za-player.angle));
        if (Math.abs(da) < arc/2){
          z.hp -= dmg;
          if (applyBleed && player.bleed){ z.bleedDps = Math.max(z.bleedDps||0, player.bleedDps); z.bleedTickUntil = now()+3000; }
          if (z.hp <= 0) { killZombie(j, z); }
          hitAny=true; addParticle(z.x,z.y,'#ff9aa2',300,2,0,0);
        }
      }
    }
    if (!hitAny) addParticle(player.x+Math.cos(player.angle)*30, player.y+Math.sin(player.angle)*30, '#a7f3d0',150,2,0,0);
  }
  function tryDash(){
    if (player.charType!=='melee') return;
    if (player.dashTime>0) return;
    if (!keys['shift']) return;
    if (player.dashCD>0 || player.stamina<15) return;
    const dx=mouse.worldX-player.x, dy=mouse.worldY-player.y, d=Math.hypot(dx,dy)||1;
    player.dashVX=dx/d*player.dashSpeed; player.dashVY=dy/d*player.dashSpeed;
    player.dashTime=180; player.dashCD=player.dashCDmax; player.stamina=Math.max(0,player.stamina-15); player.invulUntil=now()+160; audio.dash();
  }

  function parryFlash(){ parryChip.style.display='inline-flex'; setTimeout(()=>parryChip.style.display='none', 400); }
  function takeDamage(dmg){ if(!player) return; if (now()<player.invulUntil) return; player.hp-=dmg; hpFill.style.width=`${(player.hp/player.maxHp)*100}%`; addParticle(player.x,player.y,'#ff6b6b',400,3,140,120); audio.hit(); }

  // Loop
  function step(dt){
    t+=dt; if(mode==='game') elapsedMs = now()-startTimeMs;

    // Horde timer
    let hordeStr='';
    if(!horde.active){ const msLeft=Math.max(0,horde.nextAt-elapsedMs); const s=Math.ceil(msLeft/1000); hordeStr=`Орда через: ${fmt2((s/60)|0)}:${fmt2(s%60)}`; if(msLeft<=0){ horde.active=true; horde.until=elapsedMs+horde.duration; audio.horde(); hordeBanner.classList.add('show'); toast('ОРДА ПРИБЫЛА!',1200);} }
    else { const msLeft=Math.max(0,horde.until-elapsedMs); const s=Math.ceil(msLeft/1000); hordeStr=`ОРДА! ${fmt2((s/60)|0)}:${fmt2(s%60)}`; if(msLeft<=0){ horde.active=false; horde.nextAt=elapsedMs+horde.period; hordeBanner.classList.remove('show'); toast('Орда отступила…'); } }
    hordeInfo.textContent=hordeStr;

    // Medkits schedule
    if (elapsedMs > medkits.nextAt){ spawnMedkit(); medkits.nextAt = elapsedMs + rndi(medkits.period[0], medkits.period[1]); }

    // Input
    if(mode==='game' && player){
      const dir={x:0,y:0}; if(keys['w']) dir.y-=1; if(keys['s']) dir.y+=1; if(keys['a']) dir.x-=1; if(keys['d']) dir.x+=1;
      const len=Math.hypot(dir.x,dir.y)||1; dir.x/=len; dir.y/=len; const spd=player.speed*(player.block?0.6:1);
      if (player.charType==='melee' && player.dashTime>0){ player.x+=player.dashVX*dt/1000; player.y+=player.dashVY*dt/1000; player.dashTime-=dt; if(player.dashDamage){ for(let j=zombies.length-1;j>=0;j--){ const z=zombies[j]; const d=Math.hypot(z.x-player.x,z.y-player.y); if(d<z.radius+18){ z.hp-=20; if(z.hp<=0) killZombie(j,z); } } } } else { player.x+=dir.x*spd*dt/1000; player.y+=dir.y*spd*dt/1000; }
      const mx=mouse.x*DPR,my=mouse.y*DPR; mouse.worldX=camera.x-canvas.width/2+mx; mouse.worldY=camera.y-canvas.height/2+my; player.angle=Math.atan2(mouse.worldY-player.y, mouse.worldX-player.x);
      if(mouse.downL){ if(player.charType==='ranged') tryShoot(mouse.worldX,mouse.worldY); else{ meleeAttack(); if(player.whirl && player.fireCooldown<50) player.fireCooldown=50; } }
      if(mouse.downR && player.stamina>0){ if(!player.block){ player.block=true; player.lastBlockStart=now(); } } else { player.block=false; player.parryActive=false; }
      player.fireCooldown=Math.max(0,player.fireCooldown-dt); player.knifeCooldown=Math.max(0,player.knifeCooldown-dt);
      if(player.charType==='melee'){ player.dashCD=Math.max(0,player.dashCD-dt); tryDash(); }
      if(player.charType==='ranged'){ if(player.jammed && now()>=player.jamUntil){ player.jammed=false; jamChip.style.display='none'; toast('Клин устранён'); } if(player.reloading && now()>=player.reloadUntil){ const w=player.weapon; const need=Math.min(w.magSize-w.ammoInMag,w.ammoReserve); w.ammoInMag+=need; w.ammoReserve-=need; player.reloading=false; reloadChip.style.display='none'; updateHud(); } }
      const regen=player.staminaRegen||22; if(player.block){ player.stamina-=player.blockStaminaDrain*dt/1000; if(player.stamina<=0){ player.stamina=0; player.block=false; audio.click(); toast('Вы выдохлись!'); } } else { player.stamina=Math.min(player.maxStamina, player.stamina+regen*dt/1000); }
      updateHud();
    }

    // Camera
    if(player){ camera.x=lerp(camera.x,player.x,0.14); camera.y=lerp(camera.y,player.y,0.14); }

    // Spawns
    if(mode==='game'){
      const difficulty=1+(elapsedMs/60000); const rate=(1.0*(horde.active?3.2:1))*difficulty;
      if(Math.random()<rate*dt/1000){ const roll=Math.random(); if(roll<0.52) zombies.push(makeZombie()); else if(roll<0.72) zombies.push(makeFast()); else if(roll<0.88) zombies.push(makeRanged()); else zombies.push(makeDodger()); }
      if(!boss.alive && elapsedMs>boss.nextAt && Math.random()<0.004){ zombies.push(Math.random()<0.5?makeBoss():makeBossMortar()); boss.nextAt=elapsedMs+90000; }
    }

    const nowMs=now();

    // Enemies update
    for(let i=0;i<zombies.length;i++){
      const z=zombies[i];
      // bleed
      if(z.bleedTickUntil && nowMs<z.bleedTickUntil){ z.hp -= (z.bleedDps||0)*dt/1000; if(z.hp<=0){ killZombie(i,z); i--; continue; } }
      if(z.stunnedUntil>nowMs){ z.x+=(Math.random()-0.5)*10*dt/1000; z.y+=(Math.random()-0.5)*10*dt/1000; continue; }
      const dx=player.x-z.x, dy=player.y-z.y; const d=Math.hypot(dx,dy)||1;

      // dodger dash
      if(z.type==='dodger'){
        if(z.dashCooldown<=0){ for(const b of bullets){ const bx=z.x-b.x,by=z.y-b.y,bd=Math.hypot(bx,by)||1; if(bd<160){ const ang=Math.atan2(-by,-bx)+Math.PI/2*(Math.random()<0.5?1:-1); z.dashVX=Math.cos(ang)*400; z.dashVY=Math.sin(ang)*400; z.dashUntil=nowMs+180; z.dashCooldown=2200; break; } } }
        if(z.dashUntil>nowMs){ z.x+=z.dashVX*dt/1000; z.y+=z.dashVY*dt/1000; } else { z.x+=(dx/d)*z.speed*dt/1000; z.y+=(dy/d)*z.speed*dt/1000; z.dashCooldown=Math.max(0,z.dashCooldown-dt); }
        enemyTryAttack(z, nowMs);
      } else if(z.type==='ranged' || z.type==='boss2'){
        // keep distance and shoot
        const desired= (z.type==='boss2'? 380 : 280);
        const diff=d-desired, move=clamp(diff,-1,1);
        z.x+=(dx/d)*z.speed*dt/1000*(move>0?1:-0.7);
        z.y+=(dy/d)*z.speed*dt/1000*(move>0?1:-0.7);
        enemyTryAttack(z, nowMs);
      } else if(z.type==='boss'){
        if(d>120){ z.x+=(dx/d)*z.speed*dt/1000; z.y+=(dy/d)*z.speed*dt/1000; }
        enemyTryAttack(z, nowMs);
      } else {
        // normal/fast
        if(d>5){ z.x+=(dx/d)*z.speed*dt/1000; z.y+=(dy/d)*z.speed*dt/1000; }
        enemyTryAttack(z, nowMs);
      }

      // windup resolve
      if(z.state==='windup'){
        if(nowMs >= z.teleStart + z.teleDur) enemyPerformAttack(z, nowMs);
      }
    }

    

    // Bullets (player)
    for(const b of bullets){ b.px=b.x; b.py=b.y; b.x+=b.vx*dt/1000; b.y+=b.vy*dt/1000; }

    // Enemy bullets
    for(let i=eBullets.length-1;i>=0;i--){
      const b=eBullets[i];
      b.x+=b.vx*dt/1000; b.y+=b.vy*dt/1000;
      const age=now()-b.born; const dx=player.x-b.x,dy=player.y-b.y; const d=Math.hypot(dx,dy);
      if(d<player.radius+b.r+2){
        if(player.block){
          const tSince = now()-player.lastBlockStart;
          if(tSince<=player.parryWindow){ parryFlash(); audio.parry(); eBullets.splice(i,1); const ang=Math.atan2(-b.vy,-b.vx); bullets.push({x:b.x,y:b.y,vx:Math.cos(ang)*700,vy:Math.sin(ang)*700,r:4,damage:b.damage*1.6,life:900,born:now(),pierce:1,color:'#fff59d'}); continue; }
          else{ takeDamage(b.damage*(1-player.blockDamageReduct)); eBullets.splice(i,1); audio.block(); continue; }
        } else { takeDamage(b.damage); eBullets.splice(i,1); continue; }
      }
      if(age>b.life) eBullets.splice(i,1);
    }

    // Bullet collisions
    for (let i=bullets.length-1;i>=0;i--){
      const b=bullets[i]; let hit=false;
      for (let j=zombies.length-1;j>=0;j--){
        const z=zombies[j]; const dx=z.x-b.x, dy=z.y-b.y;
        if (dx*dx+dy*dy < (z.radius+b.r)**2){
          z.hp-=b.damage; hit=true; addParticle(b.x,b.y,'#ffe3a3',200,2,0,0);
          if(player.lifesteal) player.hp=Math.min(player.maxHp, player.hp + b.damage*player.lifesteal*0.25);
          if(z.hp<=0) { killZombie(j,z); }
          if(b.pierce>0){ b.pierce--; continue; } else { bullets.splice(i,1); break; }
        }
      }
      if (bullets[i] && now()-b.born>b.life) bullets.splice(i,1);
    }

    // Particles
    for (let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.x+=p.vx*dt/1000; p.y+=p.vy*dt/1000; if(now()-p.born>p.life) particles.splice(i,1); }

    // Orbs
    for (let i=orbs.length-1;i>=0;i--){
      const o=orbs[i]; const age=now()-o.born; const dx=player.x-o.x,dy=player.y-o.y; const d=Math.hypot(dx,dy)||1;
      const pull=d<200?200:40; o.vx+=(dx/d)*pull*dt/1000; o.vy+=(dy/d)*pull*dt/1000; o.vx*=0.95; o.vy*=0.95; o.x+=o.vx*dt/1000; o.y+=o.vy*dt/1000;
      if(d<player.radius+12){ player.xp+=o.xp; orbs.splice(i,1); audio.reload(); if(player.xp>=player.xpToNext){ player.level++; player.xp-=player.xpToNext; player.xpToNext=Math.round(player.xpToNext*1.2+20); showUpgrade(); } updateHud(); }
      else if(age>o.life) orbs.splice(i,1);
    }

    // Pickups (medkits + telegraphs)
    for (let i=pickups.length-1;i>=0;i--){
      const p=pickups[i]; const age=now()-p.born;
      if(p.type==='medkit'){
        const d=Math.hypot(p.x-player.x,p.y-player.y); if(d<player.radius+p.r){ player.hp=Math.min(player.maxHp, player.hp+ (p.heal||35)); pickups.splice(i,1); toast(' + Медкит'); updateHud(); continue; }
        if(age>p.life) pickups.splice(i,1);
      } else if (p.type==='telegraph'){ if(age>p.life) pickups.splice(i,1); } // рисуем в draw
    }

    // Auto-reload if empty
    if(player && player.charType==='ranged' && mode==='game' && !player.jammed && !player.reloading){
      const w=player.weapon; if(w.ammoInMag<=0 && w.ammoReserve>0){ player.reloading=true; player.reloadUntil=now()+w.reloadTime; reloadChip.style.display='inline-flex'; audio.reload(); }
    }

    if(mode==='game' && player.hp<=0) endGame();
    const s=((elapsedMs/1000)|0); timeTxt.textContent=`${fmt2((s/60)|0)}:${fmt2(s%60)}`; killsTxt.textContent=`Фрагов: ${kills}`;
  }

  // Drawing
  function draw(){
    ctx.save(); ctx.clearRect(0,0,canvas.width,canvas.height);
    drawBackground();
    if(!player){ ctx.restore(); return; }

    const ox=Math.floor(canvas.width/2 - camera.x), oy=Math.floor(canvas.height/2 - camera.y);

    // Telegraphed circles / medkits
    for(const p of pickups){
      const x=p.x+ox,y=p.y+oy;
      if(p.type==='telegraph'){
        const prog = clamp((now()-p.born)/p.life,0,1);
        ctx.beginPath(); ctx.arc(x,y, p.r + prog*28, 0, TAU);
        ctx.strokeStyle=`rgba(239,68,68,${0.6*(1-prog)+0.2})`; ctx.lineWidth=2; ctx.stroke();
        ctx.beginPath(); ctx.arc(x,y, p.r + prog*28 - 6, 0, TAU); ctx.stroke();
      } else if (p.type==='medkit'){
        ctx.save(); ctx.translate(x,y); ctx.rotate((now()/400)%TAU);
        ctx.fillStyle='#22c55e'; ctx.strokeStyle='rgba(255,255,255,.2)'; ctx.lineWidth=2;
        roundRect(ctx,-10,-10,20,20,5); ctx.fill(); ctx.stroke();
        ctx.fillStyle='#0b0f1a'; ctx.fillRect(-3,-7,6,14); ctx.fillRect(-7,-3,14,6);
        ctx.restore();
      }
    }

    // Orbs
    orbs.forEach(o=>{ const x=o.x+ox,y=o.y+oy; ctx.fillStyle='#8ab4ff'; ctx.beginPath(); ctx.arc(x,y,o.r,0,TAU); ctx.fill(); });

    // Bullets
    bullets.forEach(b=>{ const x=b.x+ox,y=b.y+oy; ctx.fillStyle=b.color; ctx.beginPath(); ctx.arc(x,y,b.r,0,TAU); ctx.fill(); if(b.px!==undefined){ ctx.strokeStyle=b.color+'88'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(b.px+ox,b.py+oy); ctx.lineTo(x,y); ctx.stroke(); } });
    eBullets.forEach(b=>{ const x=b.x+ox,y=b.y+oy; ctx.fillStyle=b.color; ctx.beginPath(); ctx.arc(x,y,b.r,0,TAU); ctx.fill(); });

    // Zombies
    zombies.forEach(z=>{
      const x=z.x+ox, y=z.y+oy;
      // telegraph during windup
      if (z.state==='windup'){
        const prog = clamp((now()-z.teleStart)/Math.max(1,z.teleDur),0,1);
        ctx.beginPath(); ctx.arc(x,y, z.radius+8+prog*12, 0, TAU);
        ctx.strokeStyle=`rgba(248,113,113,${0.2+prog*0.7})`; ctx.lineWidth=2; ctx.stroke();
      }
      ctx.save(); ctx.shadowColor='rgba(0,0,0,.6)'; ctx.shadowBlur=8;
      ctx.fillStyle=z.color; ctx.beginPath(); ctx.arc(x,y,z.radius,0,TAU); ctx.fill();
      if(z.type==='ranged'){ ctx.strokeStyle='#a3e635'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(x,y); const a=Math.atan2(player.y-z.y, player.x-z.x); ctx.lineTo(x+Math.cos(a)*z.radius*1.5, y+Math.sin(a)*z.radius*1.5); ctx.stroke(); }
      if(z.type==='boss'||z.type==='boss2'){ ctx.strokeStyle='rgba(253,186,116,.7)'; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(x,y,z.radius+6,0,TAU); ctx.stroke(); }
      ctx.restore();
      if(z.hp<z.maxHp){ const w=Math.max(0,Math.min(1,z.hp/z.maxHp)); ctx.fillStyle='rgba(0,0,0,.4)'; ctx.fillRect(x-20,y-z.radius-10,40,4); ctx.fillStyle='#34d399'; ctx.fillRect(x-20,y-z.radius-10,40*w,4); }
    });

    // Player
    const x=player.x+ox,y=player.y+oy; ctx.fillStyle='rgba(0,0,0,.35)'; ctx.beginPath(); ctx.ellipse(x,y+10,18,8,0,0,TAU); ctx.fill();
    ctx.save(); ctx.translate(x,y); ctx.rotate(player.angle);
    const bodyGrad=ctx.createLinearGradient(-18,-18,18,18); bodyGrad.addColorStop(0,'#1f3a5f'); bodyGrad.addColorStop(1,'#132238'); ctx.fillStyle=bodyGrad;
    roundRect(ctx,-18,-14,36,28,10); ctx.fill();
    // weapon/blade visual
    if (player.charType==='ranged'){
      const w=player.weapon; const vis=weaponVisual[w.type]||weaponVisual.pistol;
      ctx.fillStyle=vis.color; roundRect(ctx, 10, -vis.h/2, vis.len, vis.h, 3); ctx.fill();
      // muzzle flash hint
      if (player.fireCooldown> (1000/w.fireRate) - 60){ ctx.fillStyle=vis.muzzle; ctx.globalAlpha=.9; roundRect(ctx, 10+vis.len-2, -3, 10,6,3); ctx.fill(); ctx.globalAlpha=1; }
    } else {
      const vis=weaponVisual.blade; ctx.fillStyle=vis.color; roundRect(ctx, 8,-vis.h/2, vis.len, vis.h, 3); ctx.fill();
      if (player.fireCooldown> (1000/player.mRate) - 60){ ctx.strokeStyle='#fecdd3aa'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(0,0, player.mRange, -player.mArc/2, player.mArc/2); ctx.stroke(); }
    }
    if (player.block){ ctx.strokeStyle='rgba(94,234,212,.7)'; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(0,0,28,-Math.PI/3,Math.PI/3); ctx.stroke(); }
    ctx.restore();

    // Particles
    particles.forEach(p=>{ const px=p.x+ox,py=p.y+oy; ctx.fillStyle=p.color; ctx.globalAlpha=clamp(1-(now()-p.born)/p.life,0,1); ctx.beginPath(); ctx.arc(px,py,p.r,0,TAU); ctx.fill(); ctx.globalAlpha=1; });

    ctx.restore();
  }

  function drawBackground(){
    const gx=(camera.x*0.2)%40, gy=(camera.y*0.2)%40;
    ctx.fillStyle='rgba(255,255,255,0.02)';
    for(let x=-gx;x<canvas.width;x+=40) ctx.fillRect(x,0,1,canvas.height);
    for(let y=-gy;y<canvas.height;y+=40) ctx.fillRect(0,y,canvas.width,1);
    const grad=ctx.createRadialGradient(canvas.width/2,canvas.height/2,0,canvas.width/2,canvas.height/2,Math.max(canvas.width,canvas.height)/1.2);
    grad.addColorStop(0,'rgba(0,0,0,0)'); grad.addColorStop(1,'rgba(0,0,0,0.35)'); ctx.fillStyle=grad; ctx.fillRect(0,0,canvas.width,canvas.height);
  }
  function roundRect(ctx,x,y,w,h,r){ const rr=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath(); }

  // Loop
  function loop(){ const n=now(); let dt=n-lastTime; dt=Math.min(dt,50); lastTime=n; if(mode==='game' && !paused) step(dt); draw(); requestAnimationFrame(loop); }
  loop();

  // Minor
  setInterval(()=>{ if(!player) return; crosshairEl.style.borderColor = player.block ? 'rgba(94,234,212,.9)' : (player.jammed ? 'rgba(244,63,94,.9)' : 'rgba(255,255,255,.45)'); },50);
  addEventListener('pointerdown',()=>audio.ensure(),{once:true});
})();
</script>
</body>
</html>